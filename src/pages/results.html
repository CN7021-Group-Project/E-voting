<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VoteSecure - Election Results</title>
    <link rel="stylesheet" href="../css/results.css" />
  </head>

  <body>
    <div class="page-container">
      <div class="topbar">
        <div class="left">
          <h2>Election Results</h2>
          <p class="muted">
            Detailed summary of the final vote distribution for the selected election
          </p>
        </div>
        <div class="right">
          <a href="admin-dashboard.html" class="btn outline">
            ‚Üê Back to Dashboard
          </a>
        </div>
      </div>

      <div class="card">
        <h3 class="election-title" id="electionTitle">Loading...</h3>
        <p class="election-meta" id="electionMeta">
          Loading election details...
        </p>

        <table class="results-table">
          <thead>
            <tr>
              <th>Candidate</th>
              <th>Description</th>
              <th>Votes</th>
            </tr>
          </thead>
          <tbody id="resultsTableBody">
            <tr>
              <td colspan="3">Loading results...</td>
            </tr>
          </tbody>
        </table>

        <!-- BAR CHART ONLY -->
        <div class="chart-container">
          <h4 class="chart-heading">Votes per Candidate</h4>
          <p class="chart-caption">
            Bar chart showing the absolute number of votes received by each candidate.
          </p>
          <canvas id="resultsChart"></canvas>
        </div>
      </div>

      <div class="footer-note small muted">
        Results are automatically calculated and displayed once an election is closed.
      </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let chart = null;

      // Check authentication
      if (!isAuthenticated()) {
        window.location.href = "welcome.html";
      }

      // Get election ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const electionId = urlParams.get("id");

      if (!electionId) {
        alert("No election selected");
        window.location.href = "admin-dashboard.html";
      }

      // Load election results
      async function loadElectionResults() {
        try {
          const elections = await api.getElections();
          const election = elections.find((e) => e.id == electionId);

          if (!election) {
            alert("Election not found");
            window.location.href = "admin-dashboard.html";
            return;
          }

          // Update election info
          document.getElementById("electionTitle").textContent = election.title;
          document.getElementById("electionMeta").innerHTML = `
            Status: <strong>${election.status}</strong> &nbsp;|&nbsp;
            Ends on: <strong>${new Date(
              election.end_date
            ).toLocaleString()}</strong> &nbsp;|&nbsp;
            Total candidates: <strong>${
              election.candidates ? election.candidates.length : 0
            }</strong>
          `;

          // Update results table
          const tableBody = document.getElementById("resultsTableBody");
          tableBody.innerHTML = "";

          if (election.candidates && election.candidates.length > 0) {
            election.candidates.forEach((candidate) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${escapeHtml(candidate.name)}</td>
                <td>${escapeHtml(candidate.description || "No description")}</td>
                <td class="votes">${candidate.vote_count || 0}</td>
              `;
              tableBody.appendChild(row);
            });

            // Create bar chart
            createChart(election.candidates);
          } else {
            tableBody.innerHTML =
              '<tr><td colspan="3">No candidates found for this election.</td></tr>';
          }
        } catch (error) {
          console.error("Error loading election results:", error);
          document.getElementById("electionTitle").textContent =
            "Error Loading Results";
          document.getElementById("electionMeta").textContent =
            "Failed to load election data. Please try again later.";
          document.getElementById("resultsTableBody").innerHTML =
            '<tr><td colspan="3">Error loading results.</td></tr>';
        }
      }

      function createChart(candidates) {
        const ctx = document.getElementById("resultsChart").getContext("2d");

        if (chart) {
          chart.destroy();
        }

        const labels = candidates.map((c) => c.name);
        const data = candidates.map((c) => c.vote_count || 0);

        const colors = [
          "#667eea",
          "#764ba2",
          "#f093fb",
          "#f5576c",
          "#4facfe",
          "#00f2fe",
          "#34d399",
          "#fbbf24",
        ];

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Votes",
                data,
                backgroundColor: labels.map(
                  (_, i) => colors[i % colors.length]
                ),
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true },
            },
            scales: {
              x: {
                ticks: { maxRotation: 45, minRotation: 0 },
              },
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
              },
            },
          },
        });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      document.addEventListener("DOMContentLoaded", loadElectionResults);
    </script>
  </body>
</html>
